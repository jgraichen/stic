#!/bin/env ruby
STDOUT.sync = true

require "rubygems"
require "commander/import"
require "stic"

program :name, "stic"
program :version, Stic::VERSION.to_s
program :description, "Stic is an extensible static site generator."

default_command :help

command :build do |c|
  c.syntax = "stic build"
  c.description = "Build stic site."

  c.action do |args, options|
    unless (site = Stic::Site.lookup)
      puts "Not in a stic site. You need to run the `stic` command within a stic site."
      exit 1
    end

    STDOUT.puts  " Configuration files: #{site.config.files.join(", ")}"
    STDOUT.puts  "              Source: #{site.source}"
    STDOUT.puts  "              Target: #{site.target}"
    STDOUT.print "       Generating ... "
    STDOUT.flush

    str_length = 0

    log = lambda do |str|
      STDOUT.print "\r                      " + ' ' * str_length
      STDOUT.print "\r                  ... #{str}"
      STDOUT.flush
      str_length = str.length
    end

    begin
      site.run { |generator| log.call "Running #{generator.class.name}" }
      site.write { |blob| log.call "Write #{blob.relative_url}" }
      site.cleanup
    rescue => e
      STDOUT.puts
      raise e
    end

    log.call "done."
    STDOUT.puts
  end
end
